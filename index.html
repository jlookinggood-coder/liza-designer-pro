<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen's Baker Studio</title>
    <style>
        :root { --accent: #d00056; --soft: #ffb3c1; --light: #fff5f7; }
        body { margin: 0; background: var(--light); font-family: 'Segoe UI', sans-serif; display: flex; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* THE NEW SECURITY GATE */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--light); 
                         display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 30px; border: 2px solid var(--soft); 
                     text-align: center; box-shadow: 0 10px 30px rgba(208,0,86,0.1); }
        .login-box h2 { color: var(--accent); margin-bottom: 20px; }
        #pass-input { padding: 12px; border: 2px solid var(--soft); border-radius: 10px; width: 200px; font-size: 1rem; outline: none; text-align: center; }
        #pass-input:focus { border-color: var(--accent); }
        .login-btn { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 25px; 
                     cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        .login-btn:hover { transform: scale(1.05); }

        /* STUDIO LAYOUT */
        #main-studio { display: none; width: 100%; height: 100%; display: flex; opacity: 0; transition: opacity 0.5s; }
        #sidebar { width: 380px; background: white; border-right: 2px solid var(--soft); padding: 25px; box-sizing: border-box; overflow-y: auto; }
        h1 { color: var(--accent); font-size: 1.4rem; text-align: center; margin: 0 0 15px 0; border-bottom: 2px solid var(--light); padding-bottom: 10px; }
        .section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--light); }
        label { display: block; font-size: 0.7rem; font-weight: bold; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
        input[type="text"], select, input[type="range"] { width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 8px; border: 1px solid var(--soft); box-sizing: border-box; }
        .btn { padding: 12px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; margin-top: 5px; }
        .primary { background: var(--accent); color: white; font-size: 1rem; }
        #viewer { flex-grow: 1; position: relative; background: radial-gradient(circle, #fff 0%, #fff5f7 100%); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>ðŸ’– Queen's Studio</h2>
            <p style="color: #888; font-size: 0.9rem;">Please enter your secret code:</p>
            <input type="password" id="pass-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <br>
            <button class="login-btn" onclick="checkPass()">Enter Studio</button>
            <p id="error-msg" style="color: var(--accent); font-size: 0.8rem; margin-top: 10px; display: none;">That's not it, Amor. Try again!</p>
        </div>
    </div>

    <div id="main-studio">
        <div id="sidebar">
            <h1>ðŸŽ¨ Baker Studio Pro</h1>
            <div class="section">
                <label>Design Content</label>
                <input type="text" id="text-input" placeholder="Type something..." oninput="generateFromText()">
                <label>Upload Image</label>
                <input type="file" id="file-input" accept="image/*" onchange="processImage(event)">
            </div>
            <div class="section">
                <label>Tool Mode</label>
                <select id="mode-select" onchange="updateModel()">
                    <option value="cutter">Cookie Cutter</option>
                    <option value="roller">Texture Roller</option>
                    <option value="topper">Cake Topper</option>
                    <option value="stamp">Artisan Stamp</option>
                </select>
            </div>
            <button class="btn primary" onclick="exportSTL()">ðŸ’¾ DOWNLOAD STL</button>
            <p style="text-align:center; font-size: 0.65rem; color: #999; margin-top: 20px;">
                40 Years of Devotion â€¢ Survivor Strong
            </p>
        </div>
        <div id="viewer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/exporters/STLExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/potrace@1.1.2/dist/potrace.min.js"></script>

    <script>
        const pass = "Amor@1985";

        function checkPass() {
            const input = document.getElementById('pass-input').value;
            if (input === pass) {
                document.getElementById('login-overlay').style.display = 'none';
                const studio = document.getElementById('main-studio');
                studio.style.display = 'flex';
                setTimeout(() => studio.style.opacity = '1', 10);
                init(); // Start 3D only after login
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        // Allow "Enter" key to work
        document.getElementById('pass-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPass();
        });

        let scene, camera, renderer, group, font, currentShapes;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xfff5f7);
            camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 380) / window.innerHeight, 0.1, 1000);
            camera.position.set(0, -120, 160);
            camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth - 380, window.innerHeight);
            document.getElementById('viewer').appendChild(renderer.domElement);

            scene.add(new THREE.HemisphereLight(0xffffff, 0xffb3c1, 1.2));
            group = new THREE.Group();
            scene.add(group);

            new THREE.FontLoader().load('https://threejs.org/examples/fonts/helvetiker_bold.typeface.json', (f) => {
                font = f;
                generateFromText();
            });
            animate();
        }

        function generateFromText() {
            const text = document.getElementById('text-input').value || "AMOR";
            currentShapes = font.generateShapes(text, 25);
            updateModel();
        }

        function updateModel() {
            if (!currentShapes) return;
            while(group.children.length > 0) group.remove(group.children[0]);
            
            const mode = document.getElementById('mode-select').value;
            currentShapes.forEach(shape => {
                if (mode === 'roller') {
                    group.add(new THREE.Mesh(new THREE.CylinderGeometry(20, 20, 80, 32), new THREE.MeshStandardMaterial({color: 0xd00056})));
                    for(let i=0; i<4; i++) {
                        const tMesh = new THREE.Mesh(new THREE.ExtrudeGeometry(shape, {depth: 3, bevelEnabled: false}), new THREE.MeshStandardMaterial({color: 0xff8097}));
                        const ang = (i/4)*Math.PI*2;
                        tMesh.position.set(Math.cos(ang)*20, -10, Math.sin(ang)*20);
                        tMesh.rotation.y = -ang + Math.PI/2;
                        tMesh.scale.set(0.3, 0.3, 0.3);
                        group.add(tMesh);
                    }
                } else {
                    const bGeo = new THREE.ExtrudeGeometry(shape, { depth: 15, bevelEnabled: true, bevelSize: 0.4 });
                    group.add(new THREE.Mesh(bGeo, new THREE.MeshStandardMaterial({ color: 0xff8097 })));
                    const hGeo = new THREE.ExtrudeGeometry(shape, { depth: 4, bevelEnabled: true, bevelSize: 2, bevelThickness: 2 });
                    const hMesh = new THREE.Mesh(hGeo, new THREE.MeshStandardMaterial({ color: 0xd00056 }));
                    hMesh.position.z = -3;
                    group.add(hMesh);
                    if (mode === 'topper') {
                        const pin = new THREE.Mesh(new THREE.BoxGeometry(4, 80, 2), new THREE.MeshStandardMaterial({color: 0xd00056}));
                        pin.position.set(0, -50, -1);
                        group.add(pin);
                    }
                }
            });
            const box = new THREE.Box3().setFromObject(group);
            group.position.sub(box.getCenter(new THREE.Vector3()));
        }

        function exportSTL() {
            const res = new THREE.STLExporter().parse(group);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([res], {type: 'text/plain'}));
            link.download = 'BakerStudio.stl';
            link.click();
        }

        function animate() {
            requestAnimationFrame(animate);
            group.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if (renderer) {
                camera.aspect = (window.innerWidth - 380) / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth - 380, window.innerHeight);
            }
        });
    </script>
</body>
</html>
